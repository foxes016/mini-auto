## 後端視覺分析評估報告

### 現狀分析

目前後端的視覺分析主要集中在 `src/py_rear/services/camera_stream_processor.py` 中的 `_process_frame` 函式，以及 `src/py_rear/apis/vehicle_api.py` 中的 `_generate_autonomous_commands` 函式。

**1. `_process_frame` 函式 (視覺處理部分)：**

*   **功能**：從 MJPEG 串流中接收 JPEG 影像幀，並使用 OpenCV 進行處理。
*   **處理步驟**：
    *   **解碼**：將 JPEG 影像解碼為 OpenCV 圖像格式。
    *   **灰度轉換**：將彩色圖像轉換為灰度圖像。
    *   **高斯模糊**：應用高斯模糊以減少圖像噪音。
    *   **定義 ROI (Region of Interest)**：將分析區域限制在圖像的下半部分（從圖像高度的 50% 開始），這表明目前的視覺分析主要關注靠近車輛的地面障礙物。
    *   **自適應閾值處理**：使用 `cv2.adaptiveThreshold` 進行二值化，以檢測物體（假設物體比背景暗）。
    *   **形態學操作**：使用 `erode` 和 `dilate` 進行腐蝕和膨脹，以清理閾值處理後的圖像，去除小的噪音點並連接斷裂的物體。
    *   **輪廓檢測**：在二值化圖像中查找物體輪廓。
    *   **障礙物判斷**：
        *   如果檢測到輪廓，會找到最大的輪廓。
        *   根據輪廓的面積 (`min_area_threshold = 500`) 進行過濾，避免將小的噪音點誤判為障礙物。
        *   如果判斷為障礙物，則計算其中心點的 X 座標 (`obstacle_center_x`) 和佔用 ROI 的面積比例 (`obstacle_area_ratio`)。
*   **輸出**：將分析結果儲存在 `_latest_visual_analysis_results` 字典中，包含：
    *   `"obstacle_detected"` (布林值)：是否檢測到障礙物。
    *   `"obstacle_center_x"` (整數)：障礙物中心點的 X 座標（相對於 ROI）。
    *   `"obstacle_area_ratio"` (浮點數)：障礙物佔用 ROI 的面積比例。

**2. `_generate_autonomous_commands` 函式 (決策邏輯部分)：**

*   **功能**：根據視覺分析結果（以及超音波數據）生成馬達速度和方向指令。
*   **決策邏輯**：
    *   **優先級 1：超音波感測器**：首先檢查超音波數據。如果距離小於 20cm，則直接執行後退指令，優先級最高。
    *   **視覺分析判斷**：如果沒有超音波數據或距離足夠，則獲取 `_latest_visual_analysis_results`。
    *   **障礙物存在**：
        *   如果 `obstacle_detected` 為 `True`：
            *   **障礙物過近**：如果 `obstacle_area_ratio` 大於 0.5（表示障礙物非常大或非常近），則執行後退指令。
            *   **障礙物偏右**：如果 `obstacle_center_x` 位於圖像右側三分之一區域，則執行左轉指令。
            *   **障礙物偏左**：如果 `obstacle_center_x` 位於圖像左側三分之一區域，則執行右轉指令。
            *   **障礙物居中**：如果障礙物居中，則執行緩慢後退指令。
    *   **無障礙物**：如果沒有檢測到障礙物，則執行前進指令。

### 總結

後端的視覺分析目前實現了**基於 OpenCV 的低資源障礙物檢測**。它透過灰度轉換、模糊、閾值處理和輪廓檢測來識別圖像下半部分的潛在障礙物，並根據障礙物的大小和位置生成基本的避障決策。

**優點：**
*   **輕量級**：使用了相對簡單的 OpenCV 圖像處理技術，對計算資源要求較低。
*   **實時性**：能夠在串流中實時處理圖像並做出反應。
*   **基礎避障**：實現了基本的障礙物檢測和轉向/後退邏輯。

**局限性/未來發展方向：**
*   **環境依賴**：基於亮度閾值的方法對光照條件敏感，在複雜光照下可能不穩定。
*   **物體識別能力**：無法識別具體的物體類型（例如，是牆壁、椅子還是人）。
*   **深度感知**：僅透過物體面積比例間接判斷距離，缺乏精確的深度資訊。
*   **複雜場景**：在多個障礙物、不規則形狀或紋理複雜的環境中，表現可能不佳。
*   **路徑規劃**：目前僅是簡單的避障，沒有複雜的路徑規劃能力。
*   **訓練數據**：沒有使用機器學習模型，因此不涉及訓練數據。

總體而言，目前的視覺分析是一個**功能性但相對基礎的避障系統**，適合在相對簡單和受控的環境中運行。
